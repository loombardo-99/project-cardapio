<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Produtos - Crie seu Cardápio Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F2F5; /* Mesmo cinza da tela de layouts */
        }
        .editor-layout {
            display: flex;
            flex-direction: column; 
        }
        .sidebar { 
            width: 100%;
            min-width: auto;
            background-color: #FFFFFF;
            border-right: 1px solid #E7EAEE;
        }
        .main-content { 
            flex-grow: 1;
            width: 100%;
            background-color: #F9FAFB; /* Fundo ligeiramente diferente para o formulário */
        }
        .preview-panel { 
            width: 100%;
            background-color: #FFFFFF;
            border-left: 1px solid #E7EAEE;
        }

        @media (min-width: 1024px) { /* lg breakpoint */
            .editor-layout {
                flex-direction: row; 
            }
            .sidebar {
                width: 320px; /* Aumentado um pouco para acomodar inputs inline */
                min-width: 320px;
            }
            .preview-panel {
                width: 420px; 
                min-width: 420px;
            }
        }

        .category-item, .product-item-editor {
            transition: background-color 0.2s ease, border-left-color 0.2s ease;
            border-left: 4px solid transparent;
        }
        .category-item:hover, .product-item-editor:hover {
            background-color: #F4F5F7; /* Gray-100 mais suave */
        }
        .category-item.selected {
            background-color: #E0E7FF; 
            border-left-color: #4F46E5; 
            font-weight: 600;
        }
        .product-item-editor.selected { 
            background-color: #DBEAFE;
            border-left-color: #3B82F6; /* Blue-500 */
        }
        #imagePreview, .preview-product-img {
            width: 100%;
            object-fit: cover;
            border: 2px dashed #D1D5DB; 
            border-radius: 0.5rem; /* rounded-lg */
        }
        #imagePreview { max-height: 200px; background-color: #F9FAFB; }
        .preview-product-img { width: 80px; height: 80px; min-width:80px; border-radius: 0.375rem; border-style: solid; border-width: 1px; border-color: #E5E7EB; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(30, 41, 59, 0.7); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 0; width: 90%; max-width: 500px; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-button { color: #9CA3AF; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #1F2937; text-decoration: none; cursor: pointer; }

        #menuPreviewContainer {
            height: calc(100vh - 68px - 73px); 
            overflow-y: auto;
        }
        .preview-category-title {
            border-bottom: 3px solid #4F46E5; 
            padding-bottom: 0.5rem; margin-bottom: 1rem; font-size: 1.375rem; 
            font-weight: 700; color: #1A202C; 
        }
        .preview-product-item { display: flex; align-items: flex-start; gap: 1rem; padding: 1rem 0.5rem; border-bottom: 1px solid #F0F2F5; }
        .preview-product-item:last-child { border-bottom: none; }
        .preview-product-details h5 { font-weight: 700; color: #111827; font-size: 1.05rem; }
        .preview-product-details p { font-size: 0.875rem; color: #4B5563; max-height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4; }
        .preview-product-price { margin-left: auto; font-weight: 700; color: #1A202C; white-space: nowrap; font-size: 1.05rem; }
        
        .input-group-inline {
            display: flex;
            gap: 0.5rem; /* space-x-2 */
            margin-top: 0.75rem; /* mt-3 */
        }
        .input-group-inline input[type="text"], .input-group-inline input[type="number"] {
            flex-grow: 1;
            padding: 0.625rem 0.75rem; /* py-2.5 px-3 */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
        }
        .input-group-inline input:focus {
            outline: none;
            border-color: #4F46E5; /* focus:border-indigo-500 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); /* focus:ring-indigo-500 focus:ring-opacity-50 */
        }
        .add-inline-btn {
            padding: 0.625rem 1rem;
            background-color: #22C55E; /* bg-green-500 */
            color: white;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500; /* medium */
            transition: background-color 0.2s ease;
        }
        .add-inline-btn:hover {
            background-color: #16A34A; /* bg-green-600 */
        }
        .list-item-actions button {
            background: none; border: none; color: #9CA3AF; cursor: pointer; padding: 0.25rem;
        }
         .list-item-actions button:hover { color: #4F46E5; }

    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-indigo-600">CardápioFácil</a>
            <div class="text-sm text-gray-500">
                Passo 4 de 5: Adicione seus Produtos
            </div>
        </div>
    </header>

    <div class="editor-layout min-h-screen" style="padding-top: 68px;">
        <aside class="sidebar p-6 space-y-6">
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-gray-800">Categorias</h2>
                    <button id="openCategoryModalBtn" class="text-indigo-600 hover:text-indigo-800 text-xs font-medium hidden" title="Gerenciar Categorias (Modal)">
                        <i class="fas fa-cog"></i> Gerenciar
                    </button>
                </div>
                <div id="categoryList" class="space-y-1 mb-3 max-h-60 overflow-y-auto">
                    <p class="text-sm text-gray-500 italic p-2">Nenhuma categoria adicionada.</p>
                </div>
                <form id="addCategoryInlineForm" class="input-group-inline">
                    <input type="text" id="newCategoryName" placeholder="Nova Categoria (Ex: Bebidas)" class="w-full">
                    <button type="submit" class="add-inline-btn" title="Adicionar Categoria">
                        <i class="fas fa-plus"></i>
                    </button>
                </form>
            </div>
            <hr class="my-4">
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-gray-800">Produtos</h2>
                     <button id="showFullProductFormBtn" class="text-indigo-600 hover:text-indigo-800 text-xs font-medium" title="Adicionar Produto Detalhado" disabled>
                        <i class="fas fa-file-alt mr-1"></i> Detalhado
                    </button>
                </div>
                <div id="productListEditor" class="space-y-1 mb-3 max-h-72 overflow-y-auto">
                    <p class="text-sm text-gray-500 italic p-2">Selecione uma categoria.</p>
                </div>
                <form id="addProductQuickForm" class="space-y-2 hidden">
                    <div class="input-group-inline">
                        <input type="text" id="quickProductName" placeholder="Nome do Produto Rápido" class="w-full">
                        <input type="number" id="quickProductPrice" placeholder="Preço" step="0.01" min="0" class="w-24 text-right">
                    </div>
                    <button type="submit" class="add-inline-btn w-full">
                        <i class="fas fa-plus-circle mr-1"></i> Adicionar Produto Rápido
                    </button>
                </form>
            </div>
        </aside>

        <main class="main-content p-6 md:p-10">
            <div id="productFormContainer" class="bg-white p-8 rounded-lg shadow-xl max-w-2xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="formTitle" class="text-2xl font-bold text-gray-900">Adicionar Novo Produto</h2>
                    <button id="closeProductFormBtn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <form id="productForm" class="space-y-6">
                    <input type="hidden" id="productId" name="productId">
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
                        <input type="text" id="productName" name="productName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Hambúrguer Clássico">
                    </div>
                    <div>
                        <label for="productDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                        <textarea id="productDescription" name="productDescription" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Pão brioche, 180g de carne, queijo..."></textarea>
                    </div>
                    <div>
                        <label for="productImage" class="block text-sm font-medium text-gray-700 mb-1">Imagem do Produto</label>
                        <input type="file" id="productImage" name="productImage" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                        <img id="imagePreview" src="https://placehold.co/400x200/F3F4F6/9CA3AF?text=Preview+da+Imagem" alt="Preview da Imagem" class="mt-3 rounded-lg">
                    </div>
                     <div>
                        <label for="productCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <select id="productCategory" name="productCategory" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-1">Preço (R$)</label>
                        <input type="number" id="productPrice" name="productPrice" step="0.01" min="0" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: 25.50">
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancelEditBtn" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancelar</button>
                        <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm">Salvar Produto</button>
                    </div>
                </form>
            </div>
             <div id="welcomeMessage" class="text-center py-10 md:py-20">
                <svg class="mx-auto h-16 w-16 md:h-24 md:w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0_12.75h7.5m-7.5_3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                <h3 class="mt-4 text-xl md:text-2xl font-semibold text-gray-800">Seu Espaço Criativo do Cardápio</h3>
                <p class="mt-2 text-sm md:text-md text-gray-500 max-w-md mx-auto">Comece adicionando categorias. Depois, selecione uma categoria para adicionar seus produtos deliciosos!</p>
            </div>
        </main>

        <aside class="preview-panel p-6">
            <div id="menuPreviewContainer" class="bg-white rounded-lg shadow-lg p-3 md:p-4">
                <h3 id="previewBusinessName" class="text-xl md:text-2xl font-bold text-indigo-700 text-center mb-6">Seu Cardápio</h3>
                <div id="previewMenuList" class="space-y-6">
                    <p class="text-sm text-gray-500 italic text-center py-10">A pré-visualização do seu cardápio aparecerá aqui.</p>
                </div>
            </div>
        </aside>
    </div>

    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="categoryModalTitle" class="text-xl font-semibold">Editar Categoria</h3>
                <span class="close-button" id="closeCategoryModal">&times;</span>
            </div>
            <form id="categoryForm">
                <input type="hidden" id="categoryId" name="categoryId">
                <div>
                    <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-1">Nome da Categoria</label>
                    <input type="text" id="categoryNameInputModal" name="categoryNameModal" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Entradas, Pratos Principais">
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                     <button type="button" id="deleteCategoryBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg">Excluir</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="bg-white border-t border-gray-200 p-4 text-center sticky bottom-0 z-40">
        <button id="nextToReviewBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-10 rounded-lg text-lg shadow-md">
            Próximo: Revisar e Publicar
        </button>
    </footer>

    <script>
        let categories = [];
        let products = [];
        let selectedCategoryId = null;
        let editingProductId = null;
        let editingCategoryId = null; // Para o modal de edição de categoria
        let appData = { businessName: "Seu Negócio", selectedLayout: "default" };

        // DOM Elements
        const categoryListEl = document.getElementById('categoryList');
        const addCategoryInlineForm = document.getElementById('addCategoryInlineForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        
        const productListEditorEl = document.getElementById('productListEditor');
        const addProductQuickForm = document.getElementById('addProductQuickForm');
        const quickProductNameInput = document.getElementById('quickProductName');
        const quickProductPriceInput = document.getElementById('quickProductPrice');
        const showFullProductFormBtn = document.getElementById('showFullProductFormBtn');

        const productFormContainerEl = document.getElementById('productFormContainer');
        const productFormEl = document.getElementById('productForm');
        const closeProductFormBtn = document.getElementById('closeProductFormBtn');
        const welcomeMessageEl = document.getElementById('welcomeMessage');
        
        const categoryModal = document.getElementById('categoryModal');
        const closeCategoryModalBtn = document.getElementById('closeCategoryModal');
        const categoryFormEl = document.getElementById('categoryForm'); // Form do modal
        const categoryModalTitleEl = document.getElementById('categoryModalTitle');
        const categoryNameInputModal = document.getElementById('categoryNameInputModal'); // Input do modal
        const categoryIdInputHidden = document.getElementById('categoryId'); // Hidden input no modal
        const deleteCategoryBtn = document.getElementById('deleteCategoryBtn');
        
        const formTitleEl = document.getElementById('formTitle');
        const imagePreviewEl = document.getElementById('imagePreview');
        const productImageInput = document.getElementById('productImage');
        const productCategorySelect = document.getElementById('productCategory');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const nextToReviewBtn = document.getElementById('nextToReviewBtn');

        const previewBusinessNameEl = document.getElementById('previewBusinessName');
        const previewMenuListEl = document.getElementById('previewMenuList');

        function loadDataFromLocalStorage() {
            const storedCategories = localStorage.getItem('cardapioCategories');
            const storedProducts = localStorage.getItem('cardapioProducts');
            const storedSelectedLayout = localStorage.getItem('selectedLayoutIdGlobal');
            const storedQuizData = localStorage.getItem('quizDataGlobal');

            if (storedCategories) categories = JSON.parse(storedCategories);
            if (storedProducts) products = JSON.parse(storedProducts);

            if (storedQuizData) {
                const quizData = JSON.parse(storedQuizData);
                appData.businessName = quizData.negocioNome || "Seu Negócio";
            }
            if (storedSelectedLayout) {
                appData.selectedLayout = storedSelectedLayout;
            }
            previewBusinessNameEl.textContent = appData.businessName;
        }

        function saveDataToLocalStorage() {
            localStorage.setItem('cardapioCategories', JSON.stringify(categories));
            localStorage.setItem('cardapioProducts', JSON.stringify(products));
        }

        function renderMenuPreview() {
            previewMenuListEl.innerHTML = '';
            previewBusinessNameEl.textContent = appData.businessName;
            if (categories.length === 0) {
                previewMenuListEl.innerHTML = '<p class="text-sm text-gray-500 italic text-center py-10">Adicione categorias e produtos para ver a pré-visualização.</p>';
                return;
            }
            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-6';
                const categoryTitle = document.createElement('h4');
                categoryTitle.className = 'preview-category-title';
                categoryTitle.textContent = category.name;
                categoryDiv.appendChild(categoryTitle);
                const productsInCategory = products.filter(p => p.categoryId === category.id);
                if (productsInCategory.length > 0) {
                    const productItemsDiv = document.createElement('div');
                    productItemsDiv.className = 'space-y-3';
                    productsInCategory.forEach(product => {
                        const productItemDiv = document.createElement('div');
                        productItemDiv.className = 'preview-product-item';
                        const img = document.createElement('img');
                        img.src = product.image || `https://placehold.co/80x80/${Math.floor(Math.random()*16777215).toString(16)}/FFFFFF?text=${product.name.substring(0,1)}&font=Inter`;
                        img.alt = product.name;
                        img.className = 'preview-product-img';
                        const detailsDiv = document.createElement('div');
                        detailsDiv.className = 'preview-product-details flex-grow';
                        const productName = document.createElement('h5');
                        productName.textContent = product.name;
                        const productDesc = document.createElement('p');
                        productDesc.textContent = product.description || "Sem descrição detalhada.";
                        detailsDiv.appendChild(productName);
                        detailsDiv.appendChild(productDesc);
                        const productPrice = document.createElement('p');
                        productPrice.className = 'preview-product-price';
                        productPrice.textContent = `R$${parseFloat(product.price).toFixed(2)}`;
                        productItemDiv.appendChild(img);
                        productItemDiv.appendChild(detailsDiv);
                        productItemDiv.appendChild(productPrice);
                        productItemsDiv.appendChild(productItemDiv);
                    });
                    categoryDiv.appendChild(productItemsDiv);
                } else {
                    const noProductsMsg = document.createElement('p');
                    noProductsMsg.className = 'text-sm text-gray-400 italic ml-1 p-2';
                    noProductsMsg.textContent = 'Nenhum produto nesta categoria.';
                    categoryDiv.appendChild(noProductsMsg);
                }
                previewMenuListEl.appendChild(categoryDiv);
            });
        }

        // --- Category Functions ---
        function openCategoryEditModal(categoryIdToEdit) {
            editingCategoryId = categoryIdToEdit;
            const category = categories.find(c => c.id === categoryIdToEdit);
            if (category) {
                categoryModalTitleEl.textContent = 'Editar Categoria';
                categoryNameInputModal.value = category.name;
                categoryIdInputHidden.value = category.id; // Para o form do modal saber qual ID está editando
                categoryModal.style.display = 'block';
                categoryNameInputModal.focus();
            }
        }

        function closeCategoryModal() {
            categoryModal.style.display = 'none';
            editingCategoryId = null;
        }

        // Form de Edição de Categoria (Modal)
        categoryFormEl.addEventListener('submit', function(event) {
            event.preventDefault();
            const name = categoryNameInputModal.value.trim();
            const id = categoryIdInputHidden.value; // ID da categoria sendo editada

            if (!name) { alert('Por favor, insira um nome para a categoria.'); return; }
            if (!id) { console.error("ID da categoria para edição não encontrado."); return; }

            const index = categories.findIndex(c => c.id === id);
            if (index > -1) {
                categories[index].name = name;
                if (selectedCategoryId === id) { // Se a categoria editada era a selecionada
                    // Atualiza o nome no select do formulário de produto completo também
                    const optionInFullForm = productCategorySelect.querySelector(`option[value="${id}"]`);
                    if(optionInFullForm) optionInFullForm.textContent = name;
                }
            }
            renderCategories();
            renderMenuPreview();
            saveDataToLocalStorage();
            closeCategoryModal();
        });
        
        // Deleção de Categoria (do Modal)
        deleteCategoryBtn.addEventListener('click', function() {
            const id = categoryIdInputHidden.value;
            if (id && confirm('Tem certeza que deseja excluir esta categoria? Todos os produtos associados também serão excluídos.')) {
                categories = categories.filter(c => c.id !== id);
                products = products.filter(p => p.categoryId !== id);
                if (selectedCategoryId === id) {
                    selectedCategoryId = null;
                    productListEditorEl.innerHTML = '<p class="text-sm text-gray-500 italic p-2">Selecione uma categoria.</p>';
                    addProductQuickForm.classList.add('hidden');
                    showFullProductFormBtn.disabled = true;
                }
                renderCategories();
                renderProductsForEditor();
                renderMenuPreview();
                saveDataToLocalStorage();
                closeCategoryModal();
            }
        });

        // Adição Inline de Categoria
        addCategoryInlineForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const name = newCategoryNameInput.value.trim();
            if (!name) {
                alert('Por favor, insira um nome para a nova categoria.');
                return;
            }
            const newCategory = { id: 'cat_' + Date.now(), name: name };
            categories.push(newCategory);
            renderCategories();
            renderMenuPreview();
            saveDataToLocalStorage();
            newCategoryNameInput.value = ''; // Limpa o input
            selectCategory(newCategory.id); // Seleciona a categoria recém-criada
        });

        function renderCategories() {
            categoryListEl.innerHTML = '';
            productCategorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            if (categories.length === 0) {
                categoryListEl.innerHTML = '<p class="text-sm text-gray-500 italic p-2">Nenhuma categoria adicionada.</p>';
                return;
            }
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = `category-item p-3 rounded-md cursor-pointer flex justify-between items-center text-sm`;
                if (category.id === selectedCategoryId) div.classList.add('selected');
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = category.name;
                nameSpan.className = 'flex-grow';
                div.appendChild(nameSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'list-item-actions flex-shrink-0';
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Editar Categoria';
                editBtn.onclick = (e) => { e.stopPropagation(); openCategoryEditModal(category.id); };
                actionsDiv.appendChild(editBtn);
                div.appendChild(actionsDiv);

                div.addEventListener('click', () => selectCategory(category.id));
                categoryListEl.appendChild(div);

                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                if (category.id === selectedCategoryId) option.selected = true;
                productCategorySelect.appendChild(option);
            });
        }

        function selectCategory(categoryId) {
            selectedCategoryId = categoryId;
            editingProductId = null; 
            productFormContainerEl.classList.add('hidden'); 
            welcomeMessageEl.classList.remove('hidden');
            renderCategories(); 
            renderProductsForEditor();
            showFullProductFormBtn.disabled = !selectedCategoryId;
            if (selectedCategoryId) {
                addProductQuickForm.classList.remove('hidden');
                quickProductNameInput.focus();
            } else {
                addProductQuickForm.classList.add('hidden');
            }
        }

        // --- Product Functions ---
        function renderProductsForEditor() {
            productListEditorEl.innerHTML = '';
            if (!selectedCategoryId) {
                productListEditorEl.innerHTML = '<p class="text-sm text-gray-500 italic p-2">Selecione uma categoria.</p>';
                return;
            }
            const categoryProducts = products.filter(p => p.categoryId === selectedCategoryId);
            if (categoryProducts.length === 0) {
                productListEditorEl.innerHTML = '<p class="text-sm text-gray-500 italic p-2">Nenhum produto nesta categoria.</p>';
                return;
            }
            categoryProducts.forEach(product => {
                const div = document.createElement('div');
                div.className = `product-item-editor p-3 rounded-md cursor-pointer flex justify-between items-center text-sm`;
                if (product.id === editingProductId) div.classList.add('selected');
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = product.name;
                nameSpan.className = 'flex-grow';
                div.appendChild(nameSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'list-item-actions flex-shrink-0';
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Editar Produto (Detalhado)';
                editBtn.onclick = (e) => { e.stopPropagation(); showFullProductForm(true, product.id); };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.title = 'Excluir Produto';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteProduct(product.id); };

                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                div.appendChild(actionsDiv);
                
                div.addEventListener('click', () => showFullProductForm(true, product.id)); // Clicar no item também abre para edição
                productListEditorEl.appendChild(div);
            });
        }
        
        // Adição Rápida de Produto
        addProductQuickForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const name = quickProductNameInput.value.trim();
            const price = parseFloat(quickProductPriceInput.value);

            if (!name || isNaN(price) || price < 0) {
                alert('Nome e preço válido são obrigatórios para adição rápida.');
                return;
            }
            if (!selectedCategoryId) {
                alert('Selecione uma categoria primeiro.');
                return;
            }
            products.push({ 
                id: 'prod_' + Date.now(), 
                name: name, 
                description: '', // Descrição vazia para adição rápida
                price: price, 
                categoryId: selectedCategoryId, 
                image: null // Sem imagem para adição rápida
            });
            renderProductsForEditor();
            renderMenuPreview();
            saveDataToLocalStorage();
            quickProductNameInput.value = '';
            quickProductPriceInput.value = '';
            quickProductNameInput.focus();
        });


        function showFullProductForm(isEditing = false, productId = null) {
            productFormEl.reset();
            imagePreviewEl.src = 'https://placehold.co/400x200/F3F4F6/9CA3AF?text=Preview+da+Imagem';
            editingProductId = productId;
            renderProductsForEditor(); // Para atualizar o destaque do item selecionado na lista

            if (isEditing && productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    formTitleEl.textContent = 'Editar Produto Detalhado';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productDescription').value = product.description;
                    document.getElementById('productPrice').value = product.price;
                    productCategorySelect.value = product.categoryId;
                    if (product.image) imagePreviewEl.src = product.image;
                }
            } else { // Adicionando novo produto via formulário completo
                formTitleEl.textContent = 'Adicionar Novo Produto Detalhado';
                document.getElementById('productId').value = '';
                if (selectedCategoryId) productCategorySelect.value = selectedCategoryId;
            }
            productFormContainerEl.classList.remove('hidden');
            welcomeMessageEl.classList.add('hidden');
        }
        
        closeProductFormBtn.addEventListener('click', () => {
            productFormContainerEl.classList.add('hidden');
            welcomeMessageEl.classList.remove('hidden');
            editingProductId = null;
            renderProductsForEditor(); // Remove destaque
        });


        function deleteProduct(productId) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                products = products.filter(p => p.id !== productId);
                if (editingProductId === productId) { 
                    productFormContainerEl.classList.add('hidden');
                    welcomeMessageEl.classList.remove('hidden');
                    editingProductId = null;
                }
                renderProductsForEditor();
                renderMenuPreview();
                saveDataToLocalStorage();
            }
        }

        // Formulário Completo de Produto
        productFormEl.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('productId').value;
            const name = document.getElementById('productName').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const categoryId = document.getElementById('productCategory').value;
            const imageFile = productImageInput.files[0];

            if (!name || isNaN(price) || price < 0 || !categoryId) {
                alert('Nome, preço válido e categoria são obrigatórios.');
                return;
            }

            const processSubmit = (imageBase64) => {
                if (id) { // Editando
                    const index = products.findIndex(p => p.id === id);
                    if (index > -1) {
                        products[index] = { ...products[index], name, description, price, categoryId, image: imageFile ? imageBase64 : products[index].image };
                    }
                } else { // Novo
                    products.push({ id: 'prod_' + Date.now(), name, description, price, categoryId, image: imageBase64 });
                }
                renderProductsForEditor();
                renderMenuPreview();
                saveDataToLocalStorage();
                productFormContainerEl.classList.add('hidden');
                welcomeMessageEl.classList.remove('hidden');
                editingProductId = null; 
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onloadend = function() { processSubmit(reader.result); }
                reader.readAsDataURL(imageFile);
            } else {
                 processSubmit(id ? products.find(p=>p.id===id)?.image : null); 
            }
        });

        productImageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) { imagePreviewEl.src = e.target.result; }
                reader.readAsDataURL(file);
            } else {
                 imagePreviewEl.src = 'https://placehold.co/400x200/F3F4F6/9CA3AF?text=Preview+da+Imagem';
            }
        });

        // Event Listeners Globais
        closeCategoryModalBtn.addEventListener('click', closeCategoryModal);
        window.addEventListener('click', function(event) { 
            if (event.target == categoryModal) closeCategoryModal();
        });

        showFullProductFormBtn.addEventListener('click', () => {
            if (selectedCategoryId) {
                showFullProductForm(false); // Abre para adicionar novo
            } else {
                alert("Por favor, selecione ou crie uma categoria primeiro.");
            }
        });

        cancelEditBtn.addEventListener('click', () => {
            productFormContainerEl.classList.add('hidden');
            welcomeMessageEl.classList.remove('hidden');
            editingProductId = null;
            renderProductsForEditor(); 
        });

        nextToReviewBtn.addEventListener('click', function() {
            if (categories.length === 0 || products.length === 0) {
                alert('Por favor, adicione pelo menos uma categoria e um produto antes de prosseguir.');
                return;
            }
            saveDataToLocalStorage(); 
            window.location.href = 'publi-cardapio.html'; // Alterado aqui
        });

        // Inicialização
        loadDataFromLocalStorage();
        renderCategories();
        renderProductsForEditor(); 
        renderMenuPreview(); 

        if (categories.length > 0 && !selectedCategoryId) {
            // Opcional: selecionar a primeira categoria por defeito
            // selectCategory(categories[0].id); 
        } else if (selectedCategoryId) {
            showFullProductFormBtn.disabled = false;
            addProductQuickForm.classList.remove('hidden');
        }
    </script>
</body>
</html>
