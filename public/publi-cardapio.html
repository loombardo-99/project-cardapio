<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisar e Publicar Cardápio - Crie seu Cardápio Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
        }
        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }
        .product-row:hover {
            background-color: #F3F4F6; /* Gray-100 */
        }
        .price-input {
            max-width: 100px;
            text-align: right;
        }
        .qr-code-placeholder {
            width: 200px;
            height: 200px;
            background-color: #E5E7EB; /* Gray-200 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #6B7280; /* Gray-500 */
        }
        .menu-link-input {
            background-color: #F9FAFB; /* Gray-50 */
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-indigo-600">CardápioFácil</a>
            <div class="text-sm text-gray-500">
                Passo 5 de 5: Revise e Publique
            </div>
        </div>
    </header>

    <main class="content-wrapper px-6 py-12">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-3">Revise seu Cardápio</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Confira todos os itens e preços. Faça os ajustes finais antes de publicar.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-6 md:p-8 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Itens do Cardápio</h2>
                    <button onclick="goBackToEdit()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                        <i class="fas fa-pencil-alt mr-1"></i> Voltar para Edição
                    </button>
                </div>
                <div id="reviewMenuContainer" class="space-y-6">
                    <p class="text-gray-500 italic">Carregando itens do cardápio...</p>
                </div>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Publicar Cardápio</h2>
                
                <div class="mb-6">
                    <label for="menuLink" class="block text-sm font-medium text-gray-700 mb-1">Link do seu Cardápio:</label>
                    <div class="flex">
                        <input type="text" id="menuLink" readonly value="https://cardapiofacil.app/seu-negocio" class="menu-link-input w-full p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="copyLinkBtn" title="Copiar Link" class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-3 rounded-r-lg border border-l-0 border-gray-300">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                     <p class="text-xs text-gray-500 mt-1">Este link será ativado após a publicação e escolha de um plano.</p>
                </div>

                <div class="mb-8">
                    <p class="block text-sm font-medium text-gray-700 mb-2">QR Code do Cardápio:</p>
                    <div class="flex justify-center">
                        <div id="qrCodePlaceholder" class="qr-code-placeholder">
                            QR Code aparecerá aqui
                        </div>
                        </div>
                     <p class="text-xs text-gray-500 mt-1 text-center">Faça o download após a publicação.</p>
                </div>
                
                <button id="publishMenuBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-md transition-colors duration-300">
                    <i class="fas fa-rocket mr-2"></i>Salvar e Escolher Plano
                </button>
                <p class="text-xs text-gray-500 mt-3 text-center">Ao salvar, seu cardápio estará pronto. O próximo passo é escolher um plano para publicá-lo online.</p>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 border-t border-gray-200 p-4 text-center mt-12">
        <p class="text-sm text-gray-600">&copy; <span id="currentYear"></span> CardápioFácil. Todos os direitos reservados.</p>
    </footer>

    <script>
        let categories = [];
        let products = [];
        let appData = { businessName: "Seu Negócio", menuSlug: "seu-negocio" };

        const reviewMenuContainerEl = document.getElementById('reviewMenuContainer');
        const menuLinkInput = document.getElementById('menuLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const publishMenuBtn = document.getElementById('publishMenuBtn');
        const currentYearEl = document.getElementById('currentYear');
        const qrCodePlaceholderEl = document.getElementById('qrCodePlaceholder');


        function loadDataFromLocalStorage() {
            const storedCategories = localStorage.getItem('cardapioCategories');
            const storedProducts = localStorage.getItem('cardapioProducts');
            const storedQuizData = localStorage.getItem('quizDataGlobal');

            if (storedCategories) categories = JSON.parse(storedCategories);
            if (storedProducts) products = JSON.parse(storedProducts);
            
            if (storedQuizData) {
                const quizData = JSON.parse(storedQuizData);
                appData.businessName = quizData.negocioNome || "Seu Negócio";
                appData.menuSlug = (quizData.menuSlug || (quizData.negocioNome || "seu-negocio").toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''));
            }
            menuLinkInput.value = `https://cardapiofacil.app/${appData.menuSlug}`; // Este link é ilustrativo
        }

        function saveDataToLocalStorage() {
            localStorage.setItem('cardapioProducts', JSON.stringify(products));
            // Poderia salvar um status indicando que o cardápio foi revisado
            localStorage.setItem('cardapioRevisado', 'true');
        }

        function renderReviewMenu() {
            reviewMenuContainerEl.innerHTML = '';
            if (categories.length === 0) {
                reviewMenuContainerEl.innerHTML = '<p class="text-gray-500 italic">Nenhum item no cardápio para revisar. <a href="adicionar-produtos.html" class="text-indigo-600 hover:underline">Adicione produtos</a>.</p>';
                return;
            }

            categories.forEach(category => {
                const categorySection = document.createElement('section');
                categorySection.className = 'mb-8 p-4 border border-gray-200 rounded-lg';

                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'text-xl font-semibold text-indigo-700 mb-4 pb-2 border-b border-indigo-200';
                categoryTitle.textContent = category.name;
                categorySection.appendChild(categoryTitle);

                const productsInCategory = products.filter(p => p.categoryId === category.id);
                if (productsInCategory.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'min-w-full divide-y divide-gray-200';
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr class="bg-gray-50">
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Preço (R$)</th>
                        </tr>
                    `;
                    table.appendChild(thead);
                    
                    const tbody = document.createElement('tbody');
                    tbody.className = 'bg-white divide-y divide-gray-200';
                    productsInCategory.forEach(product => {
                        const row = document.createElement('tr');
                        row.className = 'product-row';

                        const nameCell = document.createElement('td');
                        nameCell.className = 'px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
                        nameCell.textContent = product.name;

                        const descCell = document.createElement('td');
                        descCell.className = 'px-4 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs';
                        descCell.textContent = product.description || '-';
                        descCell.title = product.description;


                        const priceCell = document.createElement('td');
                        priceCell.className = 'px-4 py-4 whitespace-nowrap text-sm text-gray-900 text-right';
                        const priceInput = document.createElement('input');
                        priceInput.type = 'number';
                        priceInput.step = '0.01';
                        priceInput.min = '0';
                        priceInput.value = parseFloat(product.price).toFixed(2);
                        priceInput.dataset.productId = product.id;
                        priceInput.className = 'price-input p-1 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500';
                        priceInput.addEventListener('change', handlePriceChange);
                        priceCell.appendChild(priceInput);

                        row.appendChild(nameCell);
                        row.appendChild(descCell);
                        row.appendChild(priceCell);
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);
                    categorySection.appendChild(table);

                } else {
                    const noProductsMsg = document.createElement('p');
                    noProductsMsg.className = 'text-sm text-gray-400 italic';
                    noProductsMsg.textContent = 'Nenhum produto nesta categoria.';
                    categorySection.appendChild(noProductsMsg);
                }
                reviewMenuContainerEl.appendChild(categorySection);
            });
        }

        function handlePriceChange(event) {
            const productId = event.target.dataset.productId;
            const newPrice = parseFloat(event.target.value);

            if (isNaN(newPrice) || newPrice < 0) {
                // Usar uma notificação não bloqueante seria melhor que alert
                console.warn('Preço inválido inserido.');
                // Reverter para o preço antigo
                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex > -1) {
                    event.target.value = parseFloat(products[productIndex].price).toFixed(2);
                }
                return;
            }

            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex > -1) {
                products[productIndex].price = newPrice;
                saveDataToLocalStorage(); 
                console.log(`Preço do produto ${productId} alterado para ${newPrice}`);
            }
        }

        function goBackToEdit() {
            window.location.href = 'adicionar-produtos.html';
        }
        
        copyLinkBtn.addEventListener('click', function() {
            menuLinkInput.select();
            menuLinkInput.setSelectionRange(0, 99999); 
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'Link copiado!' : 'Falha ao copiar.';
                // Idealmente, usar um toast/snackbar aqui
                console.log(msg); 
            } catch (err) {
                console.error('Falha ao copiar o link:', err);
            }
            window.getSelection().removeAllRanges();
        });

        publishMenuBtn.addEventListener('click', function() {
            saveDataToLocalStorage(); // Garante que os últimos preços editados sejam salvos
            console.log('Botão "Salvar e Escolher Plano" clicado. Redirecionando para escolher-planos.html');
            // Redireciona para a página de escolha de planos
            window.location.href = 'escolher-plano.html'; 
        });


        // Inicialização
        currentYearEl.textContent = new Date().getFullYear();
        loadDataFromLocalStorage();
        renderReviewMenu();

    </script>

</body>
</html>
